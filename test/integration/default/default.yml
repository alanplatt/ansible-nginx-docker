---
- name: Consul-Docker play
  hosts: test-kitchen

  vars:
    consul_datacenter:  kitchenDC
    consul_encrypt_key: '74d+D4bl59FeKo0r+U5lSA=='
    consul_primary_node: localhost
    consul_nodes:
      - "{{ ansible_default_ipv4.address }}"

    registrator_service_registry_backend: consul
    registrator_service_registry_host: "{{ ansible_default_ipv4.address }}"
    registrator_service_registry_port: 8500

    nginx_docker_consul_host: "{{ ansible_default_ipv4.address }}"
    nginx_docker_consul_port: 8500

  roles:
    - wunzeco.consul
    - wunzeco.docker
    - wunzeco.registrator
    - { role: wunzeco.consul-tools, consul_tools_name: consul-template, consul_tools_version: 0.12.1 }

  post_tasks:
    - name: Start tomcat container
      docker:
        name: jenkins
        image: jenkins
        state: running
        publish_all_ports: true
        env:
          SERVICE_NAME: jenkins


- name: Nginx-docker play
  hosts: test-kitchen

  vars:
    nginx_docker_consul_host: "{{ ansible_default_ipv4.address }}"
    nginx_docker_consul_port: 8500

  roles:
    - { role: ansible-nginx-docker,
        nginx_docker_container_name: jenkins,
        nginx_docker_http_location_prefix: '/jenkins',
        nginx_docker_http_uri: '' }

## Note: nginx_docker_container_name must be same as SERVICE_NAME
